# –ü—Ä–æ–µ–∫—Ç–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ: ETL.

## –ê–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ç—Ä–µ—Ç–∏–π —Å–ø—Ä–∏–Ω—Ç

[–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ](https://practicum.yandex.ru/learn/middle-python/courses/af061b15-1607-45f2-8d34-f88d4b21765a/sprints/5436/topics/c8fc5bcc-06bd-4098-acd2-306c2e3d8e82/lessons/b48733fd-637c-4f34-b1a1-25103549e4f3/) –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ —É–∫–∞–∑–∞–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏. –í –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ—Ç —É–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ—Ä—É—Ç–∏–Ω –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏, –ø–æ—ç—Ç–æ–º—É –≤ –º–æ–µ–º —Ä–µ—à–µ–Ω–∏–∏ –∏—Ö –Ω–µ—Ç. –¢–∞–∫ –∂–µ –Ω–µ –≤–∏–∂—É —Å–º—ã—Å–ª–∞ –≤ —Ç–µ–∫—É—â–µ–º –≤–∏–¥–µ –∏—Ö –ø—Ä–∏–º–µ–Ω—è—Ç—å.

# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è

## –°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞

–î–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è docker-compose.

–§–∞–π–ª [docker-compose.yaml](https://github.com/dimk00z/ETL/blob/main/docker-compose.yaml) —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ—Ö –æ–±—Ä–∞–∑–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞:

1. `postges_movie_db` - –æ–±—Ä–∞–∑ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è postgres. –í —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ñ–∞–π–ª—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–≤—è–∑–∞–Ω—ã —Å –ø—É—Ç–µ–º `../postgres`

2. `movies_admin` - –æ–±—Ä–∞–∑ —Å –±—ç–∫—ç–Ω–¥–æ–º django –Ω–∞ –æ—Å–Ω–æ–≤–µ [Dockerfile_django](https://github.com/dimk00z/Admin_panel_sprint_2/blob/main/Dockerfile_django). –ü—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ –≤ –æ–±—Ä–∞–∑ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ [production.txt](https://github.com/dimk00z/Admin_panel_sprint_2/blob/main/movies_admin/requirements/production.txt). –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ `gunicorn`.
3. `nginx` - –æ–±—Ä–∞–∑ —Å nginx –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ [Dockerfile_nginx](https://github.com/dimk00z/Admin_panel_sprint_2/blob/main/nginx/Dockerfile_nginx) –¥–ª—è –æ—Ç–¥–∞—á–∏ —Å—Ç–∞—Ç–∏–∫–∏ –∏ –ø—Ä–æ–±—Ä–æ—Å–∞ —Å movies_admin:8000.
4. `elasticsearch` - –æ–±—Ä–∞–∑ —Å Elasticsearch v.7.14.1 –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
5. `redis` - Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
6. `postgres_to_es` - —Å–µ—Ä–≤–∏—Å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–∑ Postgres –≤ Elasticsearch

## –û–ø–∏—Å–∞–Ω–∏–µ ETL —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- `main.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ ETL. –í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ–¥—Å—Ç–≤–∞–ª—è–µ—Ç —Å–æ–±–æ–π –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `REPEAT_TIME` –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è;
  - `def main` - –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö, –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `start_etl`. –ü–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω–Ω–µ–∫—Ç—ã;
  - `def start_etl` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö; 
- `connections.py` - —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Postgres, ES, Redis. –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `backoff` –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π;
- `state.py` - –∫–ª–∞—Å—Å—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –≤ —Ç–µ–æ—Ä–∏–∏;
- `extractor.py` - –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Postgres –≤ –ª–∏–º–∏—Ç–∞—Ö `POSTGRES_PAGE_LIMIT` –∏ –æ—Ç–¥–∞–µ—Ç –∏—Ö –≤ —Ä–µ–∂–∏–º–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ø–∏—Å–∫–æ–º –∏–∑ dataclass. –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —á–∞—Å—Ç—è–º–∏;
- `transformer.py` - –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–ª—è Elascticseacrh –≤–∏–¥;
- `loader.py` - —Å–æ–∑–¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –ø–∏—à–µ—Ç –≤ ES;
- `models.py` - –æ–ø–∏—Å–∞–Ω–∏–µ dataclasses –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤—ã–≥—Ä—É–∑–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏;
- `setting_loaders.py` - –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `pydantic`.


## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

1. –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º `.env` —Ñ–∞–π–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ `env_example`. –í–∞–∂–Ω–æ: –µ—Å–ª–∏ `ES_SHOULD_DROP_INDEX=TRUE`, —Ç–æ –∏–Ω–¥–µ–∫—Å –∏ –∑–∞–ø–∏—Å—å –≤ redit —Å–±—Ä–æ—Å—è—Ç—Å—è.
2. –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –ø–æ –ø—É—Ç–∏ `../postgres` –Ω–∞—Ö–æ–¥—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–≤—É—Ö —Å–ø—Ä–∏–Ω—Ç–æ–≤: –ø–µ—Ä–≤–∏—á–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω—ã, –≤ –±–∞–∑–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –≤—ã–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ sqlite.
4. `docker-compose up -d --build` - –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.
5. `docker-compose down -v` -  –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤


___


# –ü—Ä–æ–µ–∫—Ç–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ: ETL (–Ω–µ–∞—Ç—É–∞–ª—å–Ω–æ–µ)

–í –ø—Ä–µ–¥—ã–¥—É—â–µ–º –º–æ–¥—É–ª–µ –≤—ã —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞–ª–∏ –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞. –¢–µ–ø–µ—Ä—å —É–ª—É—á—à–∏–º –µ–≥–æ: –Ω–∞—É—á–∏–º –µ–≥–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

## –ü–æ–¥—Å–∫–∞–∑–∫–∏

–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –≤—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç–µ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–¥–∞–Ω–∏—è, –¥–∞–¥–∏–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—Å–∫–∞–∑–æ–∫:

1. –ü—Ä–µ–∂–¥–µ —á–µ–º –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ, –ø–æ–¥—É–º–∞–π—Ç–µ, —Å–∫–æ–ª—å–∫–æ ETL-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤–∞–º –Ω—É–∂–Ω–æ.
2. –î–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞ —Å–æ–≤–µ—Ç—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pydantic.
3. –î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è ETL-–ø—Ä–æ—Ü–µ—Å—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä—É—Ç–∏–Ω—ã.
4. –ß—Ç–æ–±—ã —Å–ø–æ–∫–æ–π–Ω–æ –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å –ø–∞–¥–µ–Ω–∏—è Postgres –∏–ª–∏ Elasticsearch, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ—à–µ–Ω–∏–µ —Å —Ç–µ—Ö–Ω–∏–∫–æ–π `backoff` –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–æ–∏–º—ë–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É.
5. –í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —É–º–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –Ω–∞—á–∏–Ω–∞—Ç—å —á–∏—Ç–∞—Ç—å —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ–Ω–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ —Å–≤–æ—é —Ä–∞–±–æ—Ç—É.
6. –ü—Ä–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–∏ ETL-–ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–¥—É–º–∞–π—Ç–µ, –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω—É–∂–Ω—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å –æ—Å—Ç–∞–≤–ª—è—Ç—å –≤ –∫–æ–¥–µ –∫–∞–∫ –º–æ–∂–Ω–æ –º–µ–Ω—å—à–µ ¬´–º–∞–≥–∏—á–µ—Å–∫–∏—Ö¬ª –∑–Ω–∞—á–µ–Ω–∏–π.
7. –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ë–î –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –æ–±–æ–±—â—ë–Ω–Ω—ã–º, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏—à–ª–æ—Å—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥. –ü—Ä–∏ –æ–±–æ–±—â–µ–Ω–∏–∏ –Ω–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ —Ç–æ–º, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –¥–æ–ª–∂–Ω—ã —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è.
8. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∞–π–ø–∏–Ω–≥–æ–≤ –ø–æ–º–æ–∂–µ—Ç —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –¥–µ–±–∞–≥–∞ –∏ –ø–æ–≤—ã—Å–∏—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–¥–∞ —Ä–µ–≤—å—é–µ—Ä–∞–º–∏, –∞ –∑–Ω–∞—á–∏—Ç —Ä–∞–±–æ—Ç—ã –±—É–¥—É—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –±—ã—Å—Ç—Ä–µ–µ :)
9. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–∏—à–∏—Ç–µ, —á—Ç–æ –¥–µ–ª–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∫–æ–¥–µ.
10. –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–¥—É–ª—å `logging` –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Python.

–ñ–µ–ª–∞–µ–º –≤–∞–º —É–¥–∞—á–∏ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ ETL! –í—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–∞–≤–∏—Ç–µ—Å—å üí™ 

**–†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∑–∞–ª–µ–π—Ç–µ –≤ –ø–∞–ø–∫—É `postgres_to_es` –≤–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.**


